"use strict";angular.module("w11k.select",["pasvaz.bindonce","w11k.dropdownToggle","w11k.select.template"]),angular.module("w11k.select").constant("w11kSelectConfig",{common:{templateUrl:"w11k-select.tpl.html"},instance:{required:!1,multiple:!0,disabled:!1,header:{placeholder:"",text:void 0},filter:{active:!0,placeholder:"Filter",select:{active:!0,text:void 0},deselect:{active:!0,text:void 0}},style:{marginBottom:"10px",maxHeight:void 0}}}),angular.module("w11k.select").factory("optionParser",["$parse",function(e){var t=/^\s*(.*?)(?:\s+as\s+(.*?))?\s+for\s+(?:([\$\w][\$\w\d]*))\s+in\s+(.*)$/;return{parse:function(n){var r=n.match(t);if(!r){var i='"value" [as "label"] for "item" in "collection"';throw new Error("Expected options in form of '"+i+"' but got \""+n+'".')}var o={value:e(r[1]),label:e(r[2]||r[1]),item:r[3],collection:e(r[4])};return o}}}]),angular.module("w11k.select").directive("w11kSelect",["w11kSelectConfig","$parse","$document","optionParser","$filter","$timeout","$window",function(e,t,n,r,i,o,l){var a=angular.element(l);return{restrict:"A",replace:!1,templateUrl:e.common.templateUrl,scope:{},require:"ngModel",link:function(c,u,f,s){function d(){if(g(),k(),!I){if(c.config.filter.select.active&&c.config.filter.select.text){var e=angular.element(u[0].querySelector(".select-filtered-text"));e.text(c.config.filter.select.text)}if(c.config.filter.deselect.active&&c.config.filter.deselect.text){var t=angular.element(u[0].querySelector(".deselect-filtered-text"));t.text(c.config.filter.deselect.text)}if(c.config.header.placeholder){var n=angular.element(u[0].querySelector(".header-placeholder"));n.text(c.config.header.placeholder)}I=!0}}function g(){var e=j.filter(function(e){return e.selected});c.config.multiple===!1&&e.length>0&&(c.deselectAll(),e[0].selected=!0)}function p(e,t){if(angular.isFunction(e.parents)){var r=e.parents(t);if(r.length>0)return r[0]}else{var i="MatchesSelector",o=["matches","matchesSelector","moz"+i,"webkit"+i,"ms"+i,"o"+i];for(var l in o){var a=o[l];if(angular.isFunction(e[0][a])){for(var c=e[0].parentNode;c!==n[0];){if(c[a](t))return c;c=c.parentNode}return}}}}function v(e){27===e.keyCode&&c.dropdown.close()}function m(){if(angular.isDefined(c.config.style.maxHeight))N.style.maxHeight=c.style.maxHeight;else{var e=w();N.style.maxHeight=e+"px"}}function h(){N.style.maxHeight=""}function w(){var e,t,n,r=N.getBoundingClientRect().top,i=l.innerHeight||l.document.documentElement.clientHeight;if(angular.isDefined(R)?(t=R.innerHeight||R.clientHeight,n=R.getBoundingClientRect().top):(t=l.innerHeight||l.document.documentElement.clientHeight,n=0),c.config.style.marginBottom.indexOf("px")<0)throw new Error("Illegal Value for w11kSelectStyle.marginBottom");var o,a,u=parseFloat(c.config.style.marginBottom.slice(0,-2));t+n>i?(o=i,a=0):(o=t,a=n),e=o-(r-a)-u;var f=93;return f>e&&(e=f),e}function $(){if(angular.isDefined(c.config.header.text))T.text(c.$parent.$eval(c.config.header.text));else{var e=j.filter(function(e){return e.selected}),t=e.map(function(e){return e.label});T.text(t.join(", "))}}function y(){B&&(z=K(j,c.filter.values,!1),c.options.visible=z.slice(0,G))}function x(e,t){var n=t.map(function(e){return W(e)});return e.map(function(e){var t,r=P(e),i=W(r),o=A(e);return t=-1!==n.indexOf(i)?!0:!1,{hash:i.toString(36),label:o,model:e,selected:t}})}function b(){var e=Q.collection(c.$parent),t=s.$viewValue;j=x(e,t),y(),S()}function k(){var e=F(j);s.$setViewValue(e),$()}function S(){var e=F(j);angular.forEach(s.$parsers,function(t){e=t(e)}),t(f.ngModel).assign(c.$parent,e)}function D(){var e=s.$viewValue;angular.forEach(j,function(t){var n=O(t);t.selected=-1!==e.indexOf(n)?!0:!1}),H(e),$()}function E(e){var t;return t=angular.isArray(e)?e:angular.isDefined(e)?[e]:[],H(t),t}function q(e){if(!angular.isUndefined(e)){var t;return t=c.config.multiple?e:e[0]}}function H(e){var t=!1;return c.config.required===!0&&e.length>0?t=!0:c.config.required===!1&&(t=!0),s.$setValidity("required",t),t?e:void 0}function C(){var e=s.$viewValue;return!(angular.isArray(e)&&e.length>0)}function F(e){var t=e.filter(function(e){return e.selected}),n=t.map(O);return n}function O(e){return P(e.model)}function P(e){var t={};return t[Q.item]=e,Q.value(t)}function A(e){var t={};return t[Q.item]=e,Q.label(t)}function V(e){return angular.forEach(arguments,function(t){t!==e&&angular.forEach(t,function(t,n){e[n]&&e[n].constructor&&e[n].constructor===Object?V(e[n],t):e[n]=t})}),e}var B=!1,j=[],z=[];c.options={visible:[]},c.filter={values:{}},c.config=angular.copy(e.instance);var I=!1;c.$watch(function(){return c.$parent.$eval(f.w11kSelectConfig)},function(e){angular.isArray(e)?(V.apply(null,[c.config].concat(e)),d()):angular.isObject(e)&&(V(c.config,e),d())},!0);var M="visibility",U=angular.element(u[0].querySelector(".dropdown-menu")),N=u[0].querySelector(".dropdown-menu .content"),R=p(u,".w11k-select-adjust-height-to"),T=angular.element(u[0].querySelector(".header-text"));c.dropdown={onOpen:function(e){return c.config.disabled?void e.prevent():(B===!1&&(B=!0,y()),n.on("keyup",v),U.css(M,"hidden"),o(function(){m(),U.css(M,"visible"),c.config.filter.active&&o(function(){u[0].querySelector(".dropdown-menu input").focus()})}),void a.on("resize",m))},onClose:function(){c.filter.values.label="",o(function(){h()}),n.off("keyup",v),a.off("resize",m)}},c.$on("$destroy",function(){n.off("keyup",v),a.off("resize",m)});var K=i("filter"),G=80,J=.5*G;c.showMoreOptions=function(){c.options.visible=z.slice(0,c.options.visible.length+J)},c.$watch("filter.values.label",function(){y()}),c.clearFilter=function(){c.filter.values={}},c.onKeyPressedInFilter=function(e){13===e.keyCode&&(e.preventDefault(),e.stopPropagation(),c.selectFiltered())},c.selectFiltered=function(e){angular.isDefined(e)&&(e.preventDefault(),e.stopPropagation()),c.config.multiple?angular.forEach(z,function(e){e.selected=!0}):1===z.length&&(z[0].selected=!0),k()},c.deselectFiltered=function(e){angular.isDefined(e)&&(e.preventDefault(),e.stopPropagation()),angular.forEach(z,function(e){e.selected=!1}),k()},c.deselectAll=function(e){angular.isDefined(e)&&(e.preventDefault(),e.stopPropagation()),angular.forEach(j,function(e){e.selected=!1}),k()};var L=f.w11kSelectOptions,Q=r.parse(L);c.select=function(e){e.selected===!1&&c.config.multiple===!1?(c.deselectAll(),e.selected=!0,c.dropdown.close(),k()):e.selected&&c.config.required===!1&&c.config.multiple===!1?(e.selected=!1,c.dropdown.close(),k()):c.config.multiple&&(e.selected=!e.selected,k())},c.$watchCollection(function(){return Q.collection(c.$parent)},function(e){angular.isDefined(e)&&b()}),c.onOptionStateClick=function(e,t){e.stopPropagation(),t.selected&&c.config.required&&c.config.multiple===!1&&e.preventDefault(),c.select(t)},c.isEmpty=C,s.$isEmpty=C,s.$render=D,s.$formatters.push(E),s.$parsers.push(H),s.$parsers.push(q);var W=function(){var e=function(e){for(var t=0,n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)|0;return t},t=function(t){var n=t.toString();return e(n)},n=function(e){var n=0;for(var i in e)e.hasOwnProperty(i)&&(n+=t(i+r(e[i])));return n},r=function(r){var i={string:e,number:t,"boolean":t,object:n},o=typeof r;return null===r||void 0===r?0:void 0!==i[o]?i[o](r)+t(o):0};return r}()}}}]),angular.module("w11k.select").directive("infiniteScroll",["$timeout",function(e){return{link:function(t,n,r){var i=0,o=!0,l=!1,a=function(){f(!0)},c=n[0];if(1!==c.children.length)throw new Error("scroll container has to have exactly one child!");var u=c.children[0],f=function(e){var n=u.clientHeight-c.scrollTop,a=n<=c.clientHeight*(i+1);a&&o?e?t.$apply(function(){t.$eval(r.infiniteScroll)}):t.$eval(r.infiniteScroll):a&&(l=!0)};return r.$observe("infiniteScrollDistance",function(e){i=parseFloat(e)}),r.$observe("infiniteScrollDisabled",function(e){o=!e,o&&l&&(l=!1,f())}),n.on("scroll",a),t.$on("$destroy",function(){n.off("scroll",a)}),e(function(){r.infiniteScrollImmediateCheck&&t.$eval(r.infiniteScrollImmediateCheck)&&f()})}}}]);